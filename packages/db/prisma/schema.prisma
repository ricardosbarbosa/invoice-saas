// Prisma 7 schema shared across the monorepo.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ClientStatus {
  active
  archived
}

enum InvoiceStatus {
  draft
  sent
  paid
  void
}

enum DiscountType {
  percentage
  fixed
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified Boolean   @default(false)
  image         String?
  sessions      Session[]
  accounts      Account[]

  role       String?
  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  members     Member[]
  invitations Invitation[]

  passkeys Passkey[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id                String             @id
  name              String
  slug              String
  logo              String?
  createdAt         DateTime
  metadata          String?
  members           Member[]
  invitations       Invitation[]
  clients           Client[]
  invoices          Invoice[]
  invoiceSettings   InvoiceSettings?
  organizationRoles OrganizationRole[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

model OrganizationRole {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String
  permission     String       @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime?    @updatedAt

  @@index([organizationId])
  @@index([role])
  @@map("organization_role")
}

model Client {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  email          String?
  phone          String?
  taxId          String?
  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  postalCode     String?
  country        String?
  currency       String?      @db.Char(3)
  status         ClientStatus @default(active)
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  invoices       Invoice[]

  @@index([organizationId])
  @@map("client")
}

model InvoiceSettings {
  id              String       @id @default(cuid())
  organizationId  String       @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  prefixTemplate  String       @default("INV-YYYY-")
  lastPrefix      String?
  nextNumber      Int          @default(1)
  numberPadding   Int          @default(4)
  defaultCurrency String       @default("USD") @db.Char(3)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("invoice_settings")
}

model Invoice {
  id              String        @id @default(cuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clientId        String
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  number          String
  status          InvoiceStatus @default(draft)
  issueDate       DateTime      @default(now())
  dueDate         DateTime?
  currency        String        @db.Char(3)
  discountType    DiscountType?
  discountValue   Decimal?      @db.Decimal(12, 4)
  shippingAmount  Decimal?      @db.Decimal(12, 4)
  shippingTaxRate Decimal?      @db.Decimal(5, 4)
  notes           String?
  terms           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  items           InvoiceItem[]

  @@index([organizationId])
  @@index([clientId])
  @@unique([organizationId, number])
  @@map("invoice")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal  @db.Decimal(12, 4)
  unitPrice   Decimal  @db.Decimal(12, 4)
  taxRate     Decimal? @db.Decimal(5, 4)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([invoiceId])
  @@map("invoice_item")
}

model Passkey {
  id           String    @id
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime?
  aaguid       String?

  @@index([userId])
  @@index([credentialID])
  @@map("passkey")
}
